import{saveData,getData,removeData,clearStore}from"../helpers/db-helper.min.js";import{ModeObject,Modes}from"../models/ModeObject.min.js";import{Grades}from"../models/GradeObject.min.js";import{ResultObject}from"../models/ResultObject.min.js";import{Themes}from"../models/ThemeObject.min.js";Vue.config.devtools=!1,Vue.config.debug=!1,Vue.config.silent=!0,Vue.config.ignoredElements=["app","page","navbar","settings","splash","splashwrap","message","notifications","speedControls","state","bank","commodity","detail","gameover","listheader","listings","category","name","units","currentPrice","description","market","currentValue","contractSize","goldbacking","contractUnit"];var app=new Vue({el:"#app",data:{version:"3.1.007",displayMode:"browser tab",isDropping:!1,isStopped:!0,isReady:!1,useDarkPuck:!0,lastUpdate:null,isSuccess:!1,isPlaying:!1,puckX:0,puckY:0,puckWidth:20,puckHeight:10,goodGradeThreshold:84,trailWidth:20,trailHeight:10,targetX:0,targetY:0,targetWidth:100,targetHeight:100,speed:6,dropMaxCount:3,dropCount:0,dropTotalCount:0,startingDropCount:UseDebug?5:20,score:0,lock:!1,showInstructions:!0,showHome:!0,showEndGame:!0,showSettings:!1,showYesNo:!1,hasUsedSpaceBar:!1,spaceBarInUse:!1,results:[],modes:Modes,currentMode:Modes[0],themes:Themes,grades:Grades,stageElement:document.getElementsByTagName("stage")[0],puckElement:document.getElementsByTagName("puck")[0],r:document.querySelector(":root"),c:window.getComputedStyle(document.querySelector(":root"))},methods:{ReadyStage(){note("Ready stage");let t=this.stageElement.getBoundingClientRect();this.isSuccess&&(this.dropCount=this.dropMaxCount-1),this.isSuccess=!1,this.puckY=-this.puckHeight-2,this.dropCount++,this.dropCount===this.dropMaxCount&&(this.puckY=-this.puckHeight-2,this.puckX=getRandomInt(this.puckWidth,(window.innerWidth<t.width?window.innerWidth:t.width)-this.puckWidth),this.targetHeight=getRandomInt(20,100),this.targetY=getRandomInt(100+this.puckHeight,t.height-this.targetHeight),this.dropCount=0,this.results.push(new ResultObject({count:this.dropTotalCount,difficulty:this.currentMode.name}))),this.isFirstRun&&window.innerHeight-t.y-this.targetY-this.targetHeight-2<140&&(log("Adjusting target Y position for first run"),this.targetY=t.height-this.targetHeight-140)},StopPuck(){if(note("Stopping puck"),this.dropTotalCount>0){const t=window.getComputedStyle(this.puckElement).transform.match(/matrix.*\((.+)\)/)[1].split(", ");this.puckY=t[5];let e=this.score+this.targetValue;const s=Number(this.puckY)+Number(this.puckHeight),i=Number(this.targetY),o=Number(this.targetY)+Number(this.targetHeight);s>=i-2&&s<=o+2&&(this.score=e,this.isSuccess=!0);let h=this.results[this.results.length-1];Number(this.puckY)+Number(this.puckHeight)+1>Number(this.targetHeight)+Number(this.targetY)+2?h.deltas.push(Number(this.targetHeight)+Number(this.targetY)+2-Number(this.puckY)+Number(this.puckHeight)+1):Number(this.puckY)+Number(this.puckHeight)+1<Number(this.targetY)&&h.deltas.push(Number(this.puckY)+Number(this.puckHeight)+1-Number(this.targetY)),h.count=this.dropTotalCount,h.attempts=this.dropCount,h.success=this.isSuccess,h.value=e,h.ky=this.puckY,h.kx=this.puckX,h.kh=this.puckHeight,h.ty=this.targetY,h.th=this.targetHeight,this.dropTotalCount--,0===this.dropTotalCount&&(this.lock=!0,setTimeout((()=>{this.CreateConfetti()}),200))}},HandleOkayButtonClick(){this.lock?(this.lock=!1,this.showEndGame=!0,this.finalGrade.threshold>this.goodGradeThreshold&&setTimeout((()=>{this.CreateConfetti(!0)}),200)):this.EndGame()},async SelectMode(t){note("Selected mode: "+t.name),this.isPlaying||(this.modes.forEach((t=>{t.selected=!1})),t.selected=!0,this.trailHeight=t.height,this.trailWidth=t.width,this.puckHeight=t.height,this.puckWidth=t.width,await saveData("mode",JSON.stringify(t)),this.speed=t.speed,this.currentMode=t)},async ToggleInstructions(){await saveData("showInstructions",this.showInstructions)},GetHitsOn(t){let e=0;return this.results.forEach((s=>{s.success&&s.attempts==t&&e++})),e},GetMisses(){let t=0;return this.results.forEach((e=>{t+=e.deltas.length})),t},GetHighestPossibleScore(){let t=0;return this.results.forEach((e=>{let s=this.modes.find((t=>t.name===e.difficulty)),i=parseInt(30+(100-Number(e.th))*Number(this.dropMaxCount)),o=481-e.ty,h=i?parseInt(i+o)*s.speed/this.modes[0].speed:0;t+=h})),t},GetMissedByDirection(t){let e=0;return this.results.forEach((s=>{for(let i=0;i<s.deltas.length;i++){const o=s.deltas[i];o>0&&"below"==t&&e++,o<0&&"above"==t&&e++}})),0===this.GetMisses()?0:Math.round(e/this.GetMisses()*100)},EndGame(){note("Ending game"),this.RemoveConfetti(),this.results.length>0&&4===this.results[this.results.length-1].attempts&&this.results.pop(),this.showYesNo=!1,this.showSettings=!1,this.dropTotalCount=0,this.isStopped=!0,this.isReady=!1,this.isDropping=!1,this.isPlaying=!1,this.showHome=!0},HandleActionButton(t,e){t&&(t.stopPropagation(),t.preventDefault()),this.showYesNo&&"quit"==e?this.EndGame():this.isDropping&&"stop"==e?(this.StopPuck(),this.showInstructions=!1,this.isDropping=!1,this.isStopped=!0):this.isStopped&&"next"==e?(this.ReadyStage(),this.isStopped=!1,this.isReady=!0):this.isReady&&"drop"==e&&(this.isReady=!1,this.isDropping=!0)},HandlePuckColorButtonClick(t,e){t.stopPropagation(),t.preventDefault(),this.SetPuckColor(e)},async SetPuckColor(t){this.useDarkPuck=t,this.r.style.setProperty("--puckLuminosity",(this.useDarkPuck?0:100)+"%"),await saveData("useDarkPuck",t)},HandleThemeButton(t,e){t.stopPropagation(),t.preventDefault(),this.SelectGameTheme(e.name)},async SelectGameTheme(t){var e;note("Selecting theme: "+t),this.themes.forEach((s=>{s.selected=s.name==t,s.selected&&(e=s)})),null==e&&((e=this.themes[1]).selected=!0),this.r.style.setProperty("--hue",e.h),this.r.style.setProperty("--saturation",e.s+"%"),document.getElementById("themeColor").setAttribute("content","hsl("+e.h+", "+e.s+"%, 61%)"),await saveData("theme",e.name)},UpdateApp(t){this.lastUpdate||(this.lastUpdate=t);const e=(t-this.lastUpdate)/1e3;this.lastUpdate=t,this.isDropping&&!this.puckHitBottom&&(this.puckY=Number(this.puckY)+this.speed*e)},RestartGame(){this.results=[],this.dropCount=this.dropMaxCount-1,this.dropTotalCount=this.startingDropCount,this.score=0,this.isDropping=!1,this.isStopped=!1,this.isReady=!0,this.isPlaying=!0,this.showHome=!1,this.showEndGame=!1,this.RemoveConfetti(),this.ReadyStage()},async GetSettings(){const t=["mode","theme","useDarkPuck"];for(const e of t){let t=localStorage.getItem(e);null!==t&&(await saveData(e,t),localStorage.removeItem(e))}if(null!=await getData("mode")){var e=new ModeObject(JSON.parse(await getData("mode")));this.modes.forEach((t=>{t.name==e.name&&this.SelectMode(t)}))}else this.SelectMode(this.modes[1]);null!=await getData("theme")&&this.SelectGameTheme(await getData("theme")),null!=await getData("useDarkPuck")&&this.SetPuckColor("true"==await getData("useDarkPuck"))},RemoveConfetti(){note("RemoveConfetti() called");let t=document.getElementsByTagName("confetti");for(let e=t.length-1;e>=0;e--)document.body.removeChild(t[e])},CreateConfetti(t=!1){note("CreateConfetti() called"),this.RemoveConfetti();let e=document.getElementsByTagName("app")[0],s=e.clientWidth;for(let i=0;i<s;i++){let s=document.createElement("confetti"),i=t?getRandomInt(66,84):getRandomInt(76,94);s.style.setProperty("left",getRandomInt(0,e.clientWidth)+(window.innerWidth-e.clientWidth)/2+"px"),s.style.setProperty("transition-duration",getRandomInt(1600,3001)+"ms"),s.style.setProperty("background-color","hsl("+(this.currentTheme.h+(t?180:0))+", "+(this.currentTheme.s+40)+"%, "+i+"%)"),s.style.setProperty("transition-delay",getRandomInt(0,800)+"ms"),s.style.setProperty("rotate",NaN);let o=getRandomInt(40,100)/10,h=getRandomInt(40,100)/10;s.style.setProperty("width",o+"px"),s.style.setProperty("height",h+"px"),document.body.appendChild(s)}window.setTimeout((function(){let t=document.getElementsByTagName("confetti");for(let e=0;e<t.length;e++){const s=t[e];s.style.setProperty("transform","translate("+parseInt(getRandomInt(-20,20))+"px, "+parseInt(document.body.clientHeight-s.clientHeight+20)+"px) rotate("+getRandomInt(-360,360)+"deg)"),s.className="drop"}}))},Share(){navigator.share({title:"Drop 'n Stop!",text:"The puck stops here.",url:"https://dropnstop.games"})},HandleKeyUp(t){if(this.lock)"Enter"===t.code&&this.HandleOkayButtonClick();else{let e;switch(this.themes.forEach(((t,s)=>{t.selected&&(e=s)})),t.code){case"ArrowRight":e=e==this.themes.length-1?0:e+1,null!=e&&e>=0&&this.SelectGameTheme(this.themes[e].name);break;case"ArrowLeft":e=0==e?this.themes.length-1:e-1,null!=e&&e>=0&&this.SelectGameTheme(this.themes[e].name);break;case"1":case"2":case"3":case"4":this.SelectMode(this.modes[t.key-1]);break;case"Enter":this.showYesNo&&!this.showEndGame?this.EndGame():!this.showEndGame||this.showHome||this.showSettings||this.EndGame();break;case"Escape":this.showYesNo?this.showYesNo=!1:this.showSettings?this.showSettings=!1:this.showHome&&(this.showSettings=!0);break;case"Space":this.spaceBarInUse=!1,!this.isDropping||this.showEndGame||this.showHome||this.showSettings?!(this.isReady||this.isStopped&&!this.showEndGame)||this.showEndGame||this.showHome||this.showSettings?this.showHome&&!this.showSettings&&this.RestartGame():this.HandleActionButton(t,"next"):this.HandleActionButton(t,"stop")}}},HandleKeyDown(t){if(!this.lock)switch(t.code){case"Space":this.isDropping||!this.isReady||this.showEndGame||this.isStopped||this.showHome||this.showSettings||(this.spaceBarInUse=!0,this.hasUsedSpaceBar=!0,this.HandleActionButton(t,"drop"));break}},HandleResize(){note("Handling resize"),this.RemoveConfetti()}},mounted(){this.stageElement=document.getElementsByTagName("stage")[0],this.puckElement=document.getElementsByTagName("puck")[0],window.addEventListener("keyup",this.HandleKeyUp),window.addEventListener("keydown",this.HandleKeyDown),window.addEventListener("resize",this.HandleResize),this.GetSettings();const t=e=>{this.UpdateApp(e),this._animationFrame=requestAnimationFrame(t)};this._animationFrame=requestAnimationFrame(t)},beforeDestroy(){cancelAnimationFrame(this._animationFrame),window.removeEventListener("keyup",this.HandleKeyUp),window.removeEventListener("keydown",this.HandleKeyDown),window.removeEventListener("resize",this.HandleResize)},computed:{targetValue(){let t=parseInt(30+(100-Number(this.targetHeight))*(Number(this.dropMaxCount)-Number(this.dropCount))),e=(481-this.targetY)/Number(this.dropCount+1);return Math.round(parseInt(t+e)*this.currentMode.speed/this.modes[0].speed)},hitsOnOne(){return 0===this.totalZonesClearedSucccessfully?0:Math.round(100*this.GetHitsOn(0)/this.results.length)+"%"},hitsOnTwo(){return 0===this.totalZonesClearedSucccessfully?0:Math.round(100*this.GetHitsOn(1)/this.results.length)+"%"},hitsOnThree(){return 0===this.totalZonesClearedSucccessfully?0:Math.round(100*this.GetHitsOn(2)/this.results.length)+"%"},totalZonesClearedSucccessfully(){return this.GetHitsOn(0)+this.GetHitsOn(1)+this.GetHitsOn(2)},misses(){return this.GetMisses()},highestPossibleScore(){return this.GetHighestPossibleScore()},missedAbove(){return this.GetMissedByDirection("above")+"%"},missedBelow(){return this.GetMissedByDirection("below")+"%"},userLocale:()=>navigator.language||"en-US",instructions(){let t=this.dropTotalCount+(1===this.dropTotalCount?" drop left":" drops left");switch(this.dropTotalCount){case 0:t="game over!";break;case this.startingDropCount:t='press and hold "drop" →';break;default:this.hasUsedSpaceBar||this.isChromeAndiOSoriPadOS||this.dropTotalCount%4!=0||!this.isReady||(t+="<br />(the space bar works too)");break}return t},puckHitBottom(){let t=this.stageElement.getBoundingClientRect();return this.puckY+this.puckHeight>=t.height-2},isChromeAndiOSoriPadOS(){var t=navigator.userAgent||window.opera,e=/CriOS/.test(t)||/iPhone|iPad|iPod/.test(t),s=/Firefox/.test(t)&&/Android/.test(t);return e||s},currentTheme(){let t=this.themes.find((t=>t.selected));return void 0===t&&(t=this.themes[1],t.selected=!0),t},isFirstRun(){return!this.isDropping&&this.dropTotalCount===this.startingDropCount},percentScored(){return this.score/this.highestPossibleScore},percentOfHitsIn1Drop(){return Math.round(100*this.GetHitsOn(0)/this.results.length)},finalScore(){this.results.length;let t=(this.startingDropCount-this.misses)/this.startingDropCount;return(this.percentScored+t)/2*100},finalGrade(){let t=this.totalZonesClearedSucccessfully/this.results.length,e=(this.startingDropCount-this.misses)/this.startingDropCount,s=(this.percentScored+t+e)/3,i=100*(s>this.percentScored?s:this.percentScored);return this.grades.find((t=>i>=t.threshold))||this.grades[this.grades.length-1]},thisYear:()=>(new Date).getFullYear()}});